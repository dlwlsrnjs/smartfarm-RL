## 파라미터 설정 관련 코드

본 문서는 디지털 트윈에서 사용하는 파라미터 정의, 초기값 설정, 제어 로직 및 환기/난방/CO2 계산에서 파라미터가 사용되는 핵심 코드를 한 곳에 정리한 것입니다. 각 섹션은 원본 파일 경로와 함께 실제 코드 발췌를 포함합니다.

### 1) 파라미터 구조체(Parameters) 정의와 초기값 설정

- 파일 경로: `greenlight_gym/envs/cython/define_parameters.pxd`

#### 1-1. Parameters 구조체 주요 필드 발췌

```cpp
// greenlight_gym/envs/cython/define_parameters.pxd (발췌)
from libc.math cimport exp, INFINITY, pi, M_PI

cdef packed struct Parameters:
    # --- 기본 물성/상수 ---
    double L                # Latent heat of evaporation
    double sigma            # Stefan-Boltzmann constant
    double gamma            # Psychrometric constant
    double g                # Acceleration of gravity
    short  R                # Molar gas constant
    double pressure         # Absolute air pressure at given elevation

    # --- 온실 기하/피복/대류계수 ---
    short aFlr              # Floor area of greenhouse
    short aCov              # Surface of the cover including side walls
    double hAir             # Height of the main compartment
    double hGh              # Mean height of the greenhouse
    double cHecIn           # Convective heat exchange (inside)
    double cHecOut1         # Convective heat exchange (outside)
    double cHecOut2
    char   cHecOut3

    # --- 환기/누기/풍압 ---
    short  aRoof            # Roof ventilation area
    double hVent            # Vertical dimension of single ventilation opening
    char   etaInsScr        # Insect screen porosity
    char   aSide            # Side ventilation area
    float  cDgh             # Discharge coefficient
    double cLeakage         # Leakage coefficient
    double cWgh             # Wind pressure coefficient
    char   hSideRoof        # Height diff side↔roof
    double etaRoofThr       # Roof ratio threshold
    float  cLeakTop         # Leakage fraction to top
    double minWind          # Min wind for leakage

    # --- 스크린(열차폐/암막) 광학·열 파라미터 ---
    double epsThScrFir; double tauThScrPar; double tauThScrNir; double tauThScrFir
    double rhoThScrPar;  double rhoThScrNir; double rhoThScrFir
    double kThScr;       double hThScr;       short  cPThScr

    double epsBlScrFir;  double tauBlScrPar;  double tauBlScrNir; double tauBlScrFir
    double rhoBlScrPar;  double rhoBlScrNir;  short  cPBlScr;      double hBlScr; double kBlScr

    # --- 바닥/토양/파이프 및 난방 용량 ---
    double epsPipe; double phiPipeE; double phiPipeI; double lPipe
    int    pBoil            # Heating capacity [W]
    int    pBoilGro         # Grow pipe capacity [W]
    double capPipe          # Pipe heat capacity
    double aPipe            # Pipe area per floor area

    # --- CO2 외부 공급 용량 ---
    int    phiExtCo2        # [mg s^-1]

    # --- 제어 설정/밴드 ---
    char   rhMax;    float tSpDay; double tSpNight
    char   tHeatBand; char tVentOff; char heatDeadZone
    char   ventHeatPband; char ventColdPband; char ventRhPband
    short  co2SpDay;  short co2SpNight; char co2Band
    char   thScrSpDay; char thScrSpNight; char thScrPband
    char   thScrRh;    char thScrRhPband; char thScrDeadZone
```

#### 1-2. 초기값 설정 함수 `initParameters` 전체

```cpp
// greenlight_gym/envs/cython/define_parameters.pxd (initParameters 전체)
cdef inline void initParameters(Parameters* p, char noLamps, char ledLamps, char hpsLamps, char intLamps):
    p.alfaLeafAir = 5
    p.L = 2.45e6
    p.sigma = 5.67e-8
    p.epsCan = 1
    p.epsSky = 1
    p.etaGlobNir = 0.5
    p.etaGlobPar = 0.5

    p.etaMgPpm = 0.554
    p.etaRoofThr = 0.9
    p.rhoAir0 = 1.2 
    p.rhoCanPar = 0.07
    p.rhoCanNir = 0.35
    p.rhoSteel = 7850
    p.rhoWater = 1000
    p.gamma = 65.8
    p.omega = 1.99e-7
    p.capLeaf = 1200
    p.cEvap1 = 4.3
    p.cEvap2 = 0.54

    p.cEvap3Day = 6.1e-7
    p.cEvap3Night = 1.1e-11
    p.cEvap4Day = 4.3e-6
    p.cEvap4Night = 5.2e-6
    p.cPAir = 1000
    p.cPSteel = 640
    p.cPWater = 4180
    p.g = 9.81
    p.hSo1 = 0.04 
    p.hSo2 = 0.08 
    p.hSo3 = 0.16 
    p.hSo4 = 0.32 
    p.hSo5 = 0.64 
    p.k1Par = 0.7 
    p.k2Par = 0.7 
    p.kNir = 0.27 
    p.kFir = 0.94 
    p.mAir = 28.96
    p.hSoOut = 1.28

    p.mWater = 18
    p.R = 8314
    p.rCanSp = 5
    p.rB = 275
    p.rSMin = 82
    p.sRs = -1

    ## Construction
    p.etaGlobAir = 0.1
    p.psi = 25
    p.aFlr = 14000
    p.aCov = 18000
    p.hAir = 3.8
    p.hGh = 4.2
    p.cHecIn = 1.86
    p.cHecOut1 = 2.8
    p.cHecOut2 = 1.2
    p.cHecOut3 = 1
    p.hElevation = 0

    ## Ventilation
    p.aRoof = 1400
    p.hVent = 0.68
    p.etaInsScr = 1
    p.aSide = 0
    p.cDgh = 0.75
    p.cLeakage = 1e-4
    p.cWgh = 0.09
    p.hSideRoof = 0

    ## Roof parameters
    p.epsRfFir = 0.85
    p.rhoRf = 2600
    p.rhoRfNir = 0.13
    p.rhoRfPar = 0.13
    p.rhoRfFir = 0.15
    p.tauRfNir = 0.85
    p.tauRfPar = 0.85
    p.tauRfFir = 0
    p.lambdaRf = 1.05
    p.cPRf = 840
    p.hRf = 4e-3

    ## Thermal Screen
    p.epsThScrFir = 0.67
    p.rhoThScr = 200 	
    p.rhoThScrNir = 0.35
    p.rhoThScrPar = 0.35
    p.rhoThScrFir = 0.18
    p.tauThScrNir = 0.6 
    p.tauThScrPar = 0.6 
    p.tauThScrFir = 0.15
    p.cPThScr = 1800 	
    p.hThScr = 0.35e-3 
    p.kThScr = 0.05e-3 

    ## Blackout screen
    p.epsBlScrFir = 0.67
    p.rhoBlScr = 200
    p.rhoBlScrNir = 0.35
    p.rhoBlScrPar = 0.35
    p.tauBlScrNir = 0.01
    p.tauBlScrPar = 0.01
    p.tauBlScrFir = 0.7
    p.cPBlScr = 1800
    p.hBlScr = 0.35e-3
    p.kBlScr = 0.05e-3

    ## Floor/Soil
    p.epsFlr = 1
    p.rhoFlr = 2300
    p.rhoFlrNir = 0.5
    p.rhoFlrPar = 0.65
    p.lambdaFlr = 1.7
    p.cPFlr = 880
    p.hFlr = 0.02
    p.rhoCpSo = 1730000
    p.lambdaSo = 0.85

    ## Heating system
    p.epsPipe = 0.88
    p.phiPipeE = 51e-3
    p.phiPipeI = 47e-3
    p.lPipe = 1.875
    p.pBoil = 130*p.aFlr
    p.phiExtCo2 = 72000
    p.capPipe = 0.25*pi * p.lPipe*(( p.phiPipeE**2- p.phiPipeI**2)* p.rhoSteel*\
          p.cPSteel+ p.phiPipeI**2* p.rhoWater* p.cPWater)

    p.rhoAir =  p.rhoAir0*exp(p.g* p.mAir* p.hElevation/(293.15* p.R))
    p.capAir =  p.hAir * p.rhoAir * p.cPAir
    p.capFlr =  p.hFlr * p.rhoFlr* p.cPFlr 
    p.capSo1 =  p.hSo1 * p.rhoCpSo
    p.capSo2 =  p.hSo2 * p.rhoCpSo
    p.capSo3 =  p.hSo3 * p.rhoCpSo
    p.capSo4 =  p.hSo4 * p.rhoCpSo
    p.capSo5 =  p.hSo5 * p.rhoCpSo
    p.capThScr =  p.hThScr * p.rhoThScr * p.cPThScr
    p.capTop = ( p.hGh - p.hAir) * p.rhoAir * p.cPAir
    p.capBlScr =  p.hBlScr * p.rhoBlScr * p.cPBlScr

    p.capCo2Air = p.hAir
    p.capCo2Top = p.hGh- p.hAir
    p.aPipe = pi * p.lPipe * p.phiPipeE
    p.fCanFlr = 1 - 0.49*pi * p.lPipe * p.phiPipeE
    p.pressure = 101325*(1 - 2.5577e-5*p.hElevation)**5.25588
    p.energyContentGas = 31.65  # MJ/m3

    ## Control parameters
    p.rhMax = 85
    p.dayThresh = 20
    p.tSpDay = 19.5
    p.tSpNight = 16.5
    p.tHeatBand = -1
    p.tVentOff = 1
    p.tScreenOn = 2
    p.thScrSpDay = 5
    p.thScrSpNight = 10
    p.thScrPband = -1
    p.co2SpNight = 0
    p.co2SpDay = 800
    p.co2Band = -100
    p.heatDeadZone = 5
    p.ventHeatPband = 4
    p.ventColdPband = -1
    p.ventRhPband = 5
    p.thScrRh = -2
    p.thScrRhPband = 2
    p.thScrDeadZone = 4

    ## 기타(램프/인터라이트 등) 초기화 생략 (원본 참조)
```

> 환경별 설비 스펙 반영은 위 초기값을 수정하면 됩니다. 예: 지붕 유효면적 `p.aRoof`, 방전계수 `p.cDgh`, 누기 `p.cLeakage`, 보일러 용량 `p.pBoil`, CO2 용량 `p.phiExtCo2`, 제어 setpoint/밴드 등을 현장 값으로 조정.

---

### 2) 제어 로직에서 파라미터 사용 위치

- 파일 경로: `greenlight_gym/envs/cython/compute_controls.pxd`

```cpp
// controlSignal 함수 전체 (u[0..7] 계산)
cdef inline double* controlSignal(AuxiliaryStates* a, Parameters* p, double* x, double* u, double* d):
    ...
    lampNoCons = (d[0] < p.lampsOffSun) * (d[7] < p.lampRadSumLimit) * lampTimeOfDay * lampDayOfYear
    ...
    heatSetPoint = isDayInside*p.tSpDay + (1-isDayInside)*p.tSpNight + p.heatCorrection*lampNoCons
    heatMax = heatSetPoint + p.heatDeadZone
    co2SetPoint = isDayInside*p.co2SpDay
    co2InPpm = co2dens2ppm(x[2], 1e-6*x[0])
    ventHeat = proportionalControl(x[2], heatMax, p.ventHeatPband, 0, 1)
    rhIn = 100*x[15]/satVp(x[2])
    ventRh = proportionalControl(rhIn, p.rhMax + 0 * p.mechDehumidPband, p.ventRhPband, 0, 1)
    ventCold = proportionalControl(x[2], heatSetPoint-p.tVentOff, p.ventColdPband, 1, 0)
    thScrSp = (d[8]) * p.thScrSpDay + (1- (d[8])) * p.thScrSpNight
    thScrCold = proportionalControl(d[1], thScrSp, p.thScrPband, 0, 1)
    thScrHeat = proportionalControl(x[2], heatSetPoint+p.thScrDeadZone, -p.thScrPband, 1, 0)
    thScrRh = fmax(proportionalControl(rhIn, p.rhMax+p.thScrRh, p.thScrRhPband, 1, 0), 1-ventCold)

    lampOn = lampNoCons * proportionalControl(x[2], heatMax + p.lampExtraHeat, -0.5, 0, 1) *\
                (d[9] + (1-d[9])) *\
                fmax(proportionalControl(rhIn, p.rhMax + p.blScrExtraRh, -0.5, 0, 1), 1-ventCold)

    # 최종 제어출력
    u[0] = proportionalControl(x[2], heatSetPoint, p.tHeatBand, 0, 1)
    u[1] = proportionalControl(co2InPpm, co2SetPoint, p.co2Band, 0, 1)
    u[2] = fmin(thScrCold, fmax(thScrHeat, thScrRh))
    u[3] = fmin(ventCold, fmax(ventHeat, ventRh))
    u[4] = lampOn
    u[5] = intLampOn * p.intLamps
    u[6] = proportionalControl(x[2], heatSetPoint, p.tHeatBand, 0, 1) * p.pBoilGro
    u[7] = p.useBlScr * (1-d[9]) * fmax(lampOn, intLampOn)
    return u
```

---

### 3) 환기/누기/난방/CO2 계산에서 파라미터 사용 위치

- 파일 경로: `greenlight_gym/envs/cython/auxiliary_states.pxd`

#### 3-1. 지붕 환기량(바람+부력 결합), 누기, 총 환기

```cpp
// Roof 환기량 (u[3] 개도율, p.aRoof, p.cDgh, p.cWgh, p.hVent 등)
a.fVentRoof2 = u[3] * p.aRoof * a.cD/(2*p.aFlr) * \
    sqrt(fabs(p.g*p.hVent * (x[2] - d[1]) / (2*(0.5*x[2] + 0.5*d[1] + 273.15)) + a.cW * d[4]**2))

// 누기 (풍속-임계)와 상부/측면 환기 합성
if d[4] < p.minWind:
    a.fLeakage = p.minWind * p.cLeakage
else:
    a.fLeakage = p.cLeakage * d[4]

if a.etaRoof >= p.etaRoofThr:
    a.fVentRoof = p.etaInsScr * a.fVentRoof2 + p.cLeakTop * a.fLeakage
else:
    a.fVentRoof = p.etaInsScr * (fmax(u[2], u[7]) * a.fVentRoof2 + (1 - fmax(u[2], u[7])) * a.fVentRoofSide2 * a.etaRoof) \
        + p.cLeakTop * a.fLeakage
```

> 측면 환기(`a.aSideU`, `a.fVentSide2`)는 기본 0 처리되어 있어, 측면 환기를 사용하려면 `p.aSide` 설정과 `u[10]` 활성화가 필요합니다.

#### 3-2. 보일러/그로우파이프/CO2 주입의 열·질량 수지 반영

```cpp
// 난방 열원
a.hBoilPipe    = u[0] * p.pBoil    / p.aFlr
a.hBoilGroPipe = u[6] * p.pBoilGro / p.aFlr

// CO2 주입 질량유량
a.mcExtAir = u[1] * p.phiExtCo2 / p.aFlr
```

---

### 4) 기상 입력 파이프라인(외부 → 모델 d[...])

- 파일 경로: `greenlight_gym/common/utils.py`

```python
# weatherData 매핑 요약 (d[0..9])
# d[0]: iGlob [W m^-2]
# d[1]: tOut [°C]
# d[2]: vpOut [Pa]  (RH→절대습도→수증기압 변환)
# d[3]: co2Out [mg m^-3]
# d[4]: wind [m s^-1]
# d[5]: tSky [°C]
# d[6]: tSoOut [°C]
# d[7]: dli [MJ m^-2 day^-1]
# d[8]: isDay [0/1]
# d[9]: isDaySmooth [0/1]
```

- 파일 경로: `greenlight_gym/envs/observations.py`

```python
# 관측에 사용하는 날씨 컬럼명 ↔ 인덱스
weather_idx = {
  "glob_rad": 0, "out_temp": 1, "out_rh": 2, "out_co2": 3, "wind_speed": 4,
  "sky_temp": 5, "out_soil_temp": 6, "dli": 7, "is_day": 8, "is_day_smooth": 9
}
```

---

### 5) 액추에이터 입력 인덱스 매핑(u[...])

- 파일 경로: `greenlight_gym/envs/greenlight.py`

```python
self.control_indices = {
  "uBoil": 0, "uCO2": 1, "uThScr": 2, "uVent": 3,
  "uLamp": 4, "uIntLamp": 5, "uGroPipe": 6, "uBlScr": 7,
}
```

---

### 6) 현장 적용 체크리스트(파라미터 교체 포인트)

- 환기: `p.aRoof`, `p.cDgh`, `p.cWgh`, `p.cLeakage`, `p.cLeakTop`, `p.hVent`(천창 형상/고도)
- 측면 환기: `p.aSide`(+ `u[10]` 사용 코드 활성화)
- 스크린: `p.tauThScr*`, `p.rhoThScr*`, `p.tauBlScr*`, `p.rhoBlScr*`, `p.kThScr`, `p.kBlScr`
- 난방/배관: `p.pBoil`, `p.pBoilGro`, `p.lPipe`, `p.phiPipeE/I`
- CO2: `p.phiExtCo2`, 제어 setpoint `p.co2SpDay/Night`, `p.co2Band`
- 제어 setpoint/데드존/밴드: `p.tSpDay/Night`, `p.heatDeadZone`, `p.vent*Pband`, `p.tVentOff`, `p.thScr*`

필요 시 상부 차광 스크린(문서의 상부 차광)과 측면 보온 커튼 동작을 반영하기 위해, `u[8]`(차광)·`u[10]`(측면 환기) 경로 및 관련 파라미터 블록을 활성화하는 edits를 제안드릴 수 있습니다.


